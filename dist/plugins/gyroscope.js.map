{"version":3,"file":"gyroscope.js","sources":["../../three-examples/controls/DeviceOrientationControls.js","../../src/plugins/gyroscope/GyroscopeButton.js","../../src/plugins/gyroscope/index.js"],"sourcesContent":["console.warn( \"THREE.DeviceOrientationControls: As part of the transition to ES6 Modules, the files in 'examples/js' were deprecated in May 2020 (r117) and will be deleted in December 2020 (r124). You can find more information about developing using ES6 Modules in https://threejs.org/docs/index.html#manual/en/introduction/Import-via-modules.\" );\n/**\n * @author richt / http://richt.me\n * @author WestLangley / http://github.com/WestLangley\n *\n * W3C Device Orientation control (http://w3c.github.io/deviceorientation/spec-source-orientation.html)\n */\n\nTHREE.DeviceOrientationControls = function ( object ) {\n\n\tvar scope = this;\n\n\tthis.object = object;\n\tthis.object.rotation.reorder( 'YXZ' );\n\n\tthis.enabled = true;\n\n\tthis.deviceOrientation = {};\n\tthis.screenOrientation = 0;\n\n\tthis.alphaOffset = 0; // radians\n\n\tvar onDeviceOrientationChangeEvent = function ( event ) {\n\n\t\tscope.deviceOrientation = event;\n\n\t};\n\n\tvar onScreenOrientationChangeEvent = function () {\n\n\t\tscope.screenOrientation = window.orientation || 0;\n\n\t};\n\n\t// The angles alpha, beta and gamma form a set of intrinsic Tait-Bryan angles of type Z-X'-Y''\n\n\tvar setObjectQuaternion = function () {\n\n\t\tvar zee = new THREE.Vector3( 0, 0, 1 );\n\n\t\tvar euler = new THREE.Euler();\n\n\t\tvar q0 = new THREE.Quaternion();\n\n\t\tvar q1 = new THREE.Quaternion( - Math.sqrt( 0.5 ), 0, 0, Math.sqrt( 0.5 ) ); // - PI/2 around the x-axis\n\n\t\treturn function ( quaternion, alpha, beta, gamma, orient ) {\n\n\t\t\teuler.set( beta, alpha, - gamma, 'YXZ' ); // 'ZXY' for the device, but 'YXZ' for us\n\n\t\t\tquaternion.setFromEuler( euler ); // orient the device\n\n\t\t\tquaternion.multiply( q1 ); // camera looks out the back of the device, not the top\n\n\t\t\tquaternion.multiply( q0.setFromAxisAngle( zee, - orient ) ); // adjust for screen orientation\n\n\t\t};\n\n\t}();\n\n\tthis.connect = function () {\n\n\t\tonScreenOrientationChangeEvent(); // run once on load\n\n\t\t// iOS 13+\n\n\t\tif ( window.DeviceOrientationEvent !== undefined && typeof window.DeviceOrientationEvent.requestPermission === 'function' ) {\n\n\t\t\twindow.DeviceOrientationEvent.requestPermission().then( function ( response ) {\n\n\t\t\t\tif ( response == 'granted' ) {\n\n\t\t\t\t\twindow.addEventListener( 'orientationchange', onScreenOrientationChangeEvent, false );\n\t\t\t\t\twindow.addEventListener( 'deviceorientation', onDeviceOrientationChangeEvent, false );\n\n\t\t\t\t}\n\n\t\t\t} ).catch( function ( error ) {\n\n\t\t\t\tconsole.error( 'THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:', error );\n\n\t\t\t} );\n\n\t\t} else {\n\n\t\t\twindow.addEventListener( 'orientationchange', onScreenOrientationChangeEvent, false );\n\t\t\twindow.addEventListener( 'deviceorientation', onDeviceOrientationChangeEvent, false );\n\n\t\t}\n\n\t\tscope.enabled = true;\n\n\t};\n\n\tthis.disconnect = function () {\n\n\t\twindow.removeEventListener( 'orientationchange', onScreenOrientationChangeEvent, false );\n\t\twindow.removeEventListener( 'deviceorientation', onDeviceOrientationChangeEvent, false );\n\n\t\tscope.enabled = false;\n\n\t};\n\n\tthis.update = function () {\n\n\t\tif ( scope.enabled === false ) return;\n\n\t\tvar device = scope.deviceOrientation;\n\n\t\tif ( device ) {\n\n\t\t\tvar alpha = device.alpha ? THREE.MathUtils.degToRad( device.alpha ) + scope.alphaOffset : 0; // Z\n\n\t\t\tvar beta = device.beta ? THREE.MathUtils.degToRad( device.beta ) : 0; // X'\n\n\t\t\tvar gamma = device.gamma ? THREE.MathUtils.degToRad( device.gamma ) : 0; // Y''\n\n\t\t\tvar orient = scope.screenOrientation ? THREE.MathUtils.degToRad( scope.screenOrientation ) : 0; // O\n\n\t\t\tsetObjectQuaternion( scope.object.quaternion, alpha, beta, gamma, orient );\n\n\t\t}\n\n\n\t};\n\n\tthis.dispose = function () {\n\n\t\tscope.disconnect();\n\n\t};\n\n\tthis.connect();\n\n};\n","import { AbstractButton } from 'photo-sphere-viewer';\r\nimport compass from './compass.svg';\r\nimport GyroscopePlugin from './index';\r\n\r\n/**\r\n * @summary Navigation bar gyroscope button class\r\n * @extends PSV.buttons.AbstractButton\r\n * @memberof PSV.buttons\r\n */\r\nexport class GyroscopeButton extends AbstractButton {\r\n\r\n  static id = 'gyroscope';\r\n  static icon = compass;\r\n\r\n  /**\r\n   * @param {PSV.components.Navbar} navbar\r\n   */\r\n  constructor(navbar) {\r\n    super(navbar, 'psv-button--hover-scale psv-gyroscope-button', true);\r\n\r\n    /**\r\n     * @type {PSV.plugins.GyroscopePlugin}\r\n     * @readonly\r\n     * @private\r\n     */\r\n    this.plugin = this.psv.getPlugin(GyroscopePlugin.id);\r\n\r\n    if (this.plugin) {\r\n      this.plugin.on(GyroscopePlugin.EVENTS.GYROSCOPE_UPDATED, this);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  destroy() {\r\n    if (this.plugin) {\r\n      this.plugin.off(GyroscopePlugin.EVENTS.GYROSCOPE_UPDATED, this);\r\n    }\r\n\r\n    delete this.plugin;\r\n\r\n    super.destroy();\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  isSupported() {\r\n    return !this.plugin ? false : { initial: false, promise: this.plugin.prop.isSupported };\r\n  }\r\n\r\n  /**\r\n   * @summary Handles events\r\n   * @param {Event} e\r\n   * @private\r\n   */\r\n  handleEvent(e) {\r\n    if (e.type === GyroscopePlugin.EVENTS.GYROSCOPE_UPDATED) {\r\n      this.toggleActive(e.args[0]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   * @description Toggles gyroscope control\r\n   */\r\n  onClick() {\r\n    this.plugin.toggle();\r\n  }\r\n\r\n}\r\n","import { AbstractPlugin, CONSTANTS, DEFAULTS, registerButton, utils } from 'photo-sphere-viewer';\r\nimport * as THREE from 'three';\r\nimport 'three/examples/js/controls/DeviceOrientationControls';\r\nimport { GyroscopeButton } from './GyroscopeButton';\r\n\r\n/**\r\n * @typedef {Object} external:THREE.DeviceOrientationControls\r\n * @summary {@link https://github.com/mrdoob/three.js/blob/dev/examples/js/controls/DeviceOrientationControls.js}\r\n */\r\n\r\n\r\n// add gyroscope button\r\nDEFAULTS.navbar.splice(-1, 0, GyroscopeButton.id);\r\nDEFAULTS.lang[GyroscopeButton.id] = 'Gyroscope';\r\nregisterButton(GyroscopeButton);\r\n\r\n\r\n/**\r\n * @summary Adds gyroscope controls on mobile devices\r\n * @extends PSV.plugins.AbstractPlugin\r\n * @memberof PSV.plugins\r\n */\r\nexport default class GyroscopePlugin extends AbstractPlugin {\r\n\r\n  static id = 'gyroscope';\r\n\r\n  /**\r\n   * @summary Available events\r\n   * @enum {string}\r\n   * @memberof PSV.plugins.GyroscopePlugin\r\n   * @constant\r\n   */\r\n  static EVENTS = {\r\n    GYROSCOPE_UPDATED: 'gyroscope-updated',\r\n  };\r\n\r\n  /**\r\n   * @param {PSV.Viewer} psv\r\n   */\r\n  constructor(psv) {\r\n    super(psv);\r\n\r\n    /**\r\n     * @member {Object}\r\n     * @private\r\n     * @property {Promise<boolean>} isSupported - indicates of the gyroscope API is available\r\n     * @property {number} alphaOffset - current alpha offset for gyroscope controls\r\n     * @property {Function} orientationCb - update callback of the device orientation\r\n     * @property {boolean} config_moveInertia - original config \"moveInertia\"\r\n     */\r\n    this.prop = {\r\n      isSupported       : this.__checkSupport(),\r\n      alphaOffset       : 0,\r\n      orientationCb     : null,\r\n      config_moveInertia: true,\r\n    };\r\n\r\n    /**\r\n     * @member {external:THREE.DeviceOrientationControls}\r\n     * @private\r\n     */\r\n    this.controls = null;\r\n\r\n    this.psv.on(CONSTANTS.EVENTS.STOP_ALL, this);\r\n    this.psv.on(CONSTANTS.EVENTS.BEFORE_ROTATE, this);\r\n  }\r\n\r\n  /**\r\n   * @package\r\n   */\r\n  destroy() {\r\n    this.psv.off(CONSTANTS.EVENTS.STOP_ALL, this);\r\n    this.psv.off(CONSTANTS.EVENTS.BEFORE_ROTATE, this);\r\n\r\n    this.stop();\r\n\r\n    delete this.controls;\r\n    delete this.prop;\r\n\r\n    super.destroy();\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  handleEvent(e) {\r\n    switch (e.type) {\r\n      case CONSTANTS.EVENTS.STOP_ALL:\r\n        this.stop();\r\n        break;\r\n      case CONSTANTS.EVENTS.BEFORE_ROTATE:\r\n        this.__onRotate(e);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Checks if the gyroscope is enabled\r\n   * @returns {boolean}\r\n   */\r\n  isEnabled() {\r\n    return !!this.prop.orientationCb;\r\n  }\r\n\r\n  /**\r\n   * @summary Enables the gyroscope navigation if available\r\n   * @returns {Promise}\r\n   * @fires PSV.plugins.GyroscopePlugin.gyroscope-updated\r\n   * @throws {PSV.PSVError} if the gyroscope API is not available/granted\r\n   */\r\n  start() {\r\n    return this.prop.isSupported\r\n      .then((supported) => {\r\n        if (supported) {\r\n          return this.__requestPermission();\r\n        }\r\n        else {\r\n          utils.logWarn('gyroscope not available');\r\n          return Promise.reject();\r\n        }\r\n      })\r\n      .then((granted) => {\r\n        if (granted) {\r\n          return Promise.resolve();\r\n        }\r\n        else {\r\n          utils.logWarn('gyroscope not allowed');\r\n          return Promise.reject();\r\n        }\r\n      })\r\n      .then(() => {\r\n        this.psv.__stopAll();\r\n\r\n        // disable inertia\r\n        this.prop.config_moveInertia = this.psv.config.moveInertia;\r\n        this.psv.config.moveInertia = false;\r\n\r\n        this.__configure();\r\n\r\n        /**\r\n         * @event gyroscope-updated\r\n         * @memberof PSV.plugins.GyroscopePlugin\r\n         * @summary Triggered when the gyroscope mode is enabled/disabled\r\n         * @param {boolean} enabled\r\n         */\r\n        this.trigger(GyroscopePlugin.EVENTS.GYROSCOPE_UPDATED, true);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * @summary Disables the gyroscope navigation\r\n   * @fires PSV.plugins.GyroscopePlugin.gyroscope-updated\r\n   */\r\n  stop() {\r\n    if (this.isEnabled()) {\r\n      this.controls.disconnect();\r\n\r\n      this.psv.off(CONSTANTS.EVENTS.BEFORE_RENDER, this.prop.orientationCb);\r\n      this.prop.orientationCb = null;\r\n\r\n      this.psv.config.moveInertia = this.prop.config_moveInertia;\r\n\r\n      this.trigger(GyroscopePlugin.EVENTS.GYROSCOPE_UPDATED, false);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Enables or disables the gyroscope navigation\r\n   */\r\n  toggle() {\r\n    if (this.isEnabled()) {\r\n      this.stop();\r\n    }\r\n    else {\r\n      this.start();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Attaches the {@link DeviceOrientationControls} to the camera\r\n   * @private\r\n   */\r\n  __configure() {\r\n    if (!this.controls) {\r\n      this.controls = new THREE.DeviceOrientationControls(this.psv.renderer.camera);\r\n    }\r\n    else {\r\n      this.controls.connect();\r\n    }\r\n\r\n    const direction = this.psv.renderer.camera.getWorldDirection(new THREE.Vector3());\r\n    const sphericalDirection = this.psv.dataHelper.vector3ToSphericalCoords(direction);\r\n    this.prop.alphaOffset = utils.getShortestArc(this.psv.prop.position.longitude, sphericalDirection.longitude);\r\n\r\n    this.prop.orientationCb = () => {\r\n      this.controls.alphaOffset = this.prop.alphaOffset;\r\n      this.controls.update();\r\n\r\n      this.psv.renderer.camera.getWorldDirection(this.psv.prop.direction);\r\n      this.psv.prop.direction.multiplyScalar(CONSTANTS.SPHERE_RADIUS);\r\n\r\n      const sphericalCoords = this.psv.dataHelper.vector3ToSphericalCoords(this.psv.prop.direction);\r\n      this.psv.prop.position.longitude = sphericalCoords.longitude;\r\n      this.psv.prop.position.latitude = sphericalCoords.latitude;\r\n      this.psv.needsUpdate();\r\n    };\r\n\r\n    this.psv.on(CONSTANTS.EVENTS.BEFORE_RENDER, this.prop.orientationCb);\r\n  }\r\n\r\n  /**\r\n   * @summary Intercepts moves and offsets the alpha angle\r\n   * @param {external:uEvent.Event} e\r\n   * @private\r\n   */\r\n  __onRotate(e) {\r\n    if (this.isEnabled()) {\r\n      e.preventDefault();\r\n\r\n      this.prop.alphaOffset -= e.args[0].longitude - this.psv.prop.position.longitude;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Detects if device orientation is supported\r\n   * @returns {Promise<boolean>}\r\n   * @private\r\n   */\r\n  __checkSupport() {\r\n    if ('DeviceMotionEvent' in window && typeof DeviceMotionEvent.requestPermission === 'function') {\r\n      return Promise.resolve(true);\r\n    }\r\n    else if ('DeviceOrientationEvent' in window) {\r\n      return new Promise((resolve) => {\r\n        const listener = (e) => {\r\n          /* eslint-disable-next-line no-restricted-globals */\r\n          resolve(e && e.alpha !== null && !isNaN(e.alpha));\r\n\r\n          window.removeEventListener('deviceorientation', listener);\r\n        };\r\n\r\n        window.addEventListener('deviceorientation', listener, false);\r\n\r\n        // after 2 secs, auto-reject the promise\r\n        setTimeout(listener, 2000);\r\n      });\r\n    }\r\n    else {\r\n      return Promise.resolve(false);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Request permission to the motion API\r\n   * @returns {Promise<boolean>}\r\n   * @private\r\n   */\r\n  __requestPermission() {\r\n    if ('DeviceMotionEvent' in window && typeof DeviceMotionEvent.requestPermission === 'function') {\r\n      return DeviceOrientationEvent.requestPermission()\r\n        .then(response => response === 'granted')\r\n        .catch(() => false);\r\n    }\r\n    else {\r\n      return Promise.resolve(true);\r\n    }\r\n  }\r\n\r\n}\r\n"],"names":["console","warn","THREE","DeviceOrientationControls","object","scope","rotation","reorder","enabled","deviceOrientation","screenOrientation","alphaOffset","onDeviceOrientationChangeEvent","event","onScreenOrientationChangeEvent","window","orientation","setObjectQuaternion","zee","Vector3","euler","Euler","q0","Quaternion","q1","Math","sqrt","quaternion","alpha","beta","gamma","orient","set","setFromEuler","multiply","setFromAxisAngle","connect","DeviceOrientationEvent","undefined","requestPermission","then","response","addEventListener","catch","error","disconnect","removeEventListener","update","device","MathUtils","degToRad","dispose","GyroscopeButton","navbar","plugin","psv","getPlugin","GyroscopePlugin","id","on","EVENTS","GYROSCOPE_UPDATED","destroy","off","isSupported","initial","promise","prop","handleEvent","e","type","toggleActive","args","onClick","toggle","AbstractButton","icon","compass","DEFAULTS","splice","lang","registerButton","__checkSupport","orientationCb","config_moveInertia","controls","CONSTANTS","STOP_ALL","BEFORE_ROTATE","stop","__onRotate","isEnabled","start","supported","__requestPermission","utils","logWarn","Promise","reject","granted","resolve","__stopAll","config","moveInertia","__configure","trigger","BEFORE_RENDER","renderer","camera","direction","getWorldDirection","sphericalDirection","dataHelper","vector3ToSphericalCoords","getShortestArc","position","longitude","multiplyScalar","SPHERE_RADIUS","sphericalCoords","latitude","needsUpdate","preventDefault","DeviceMotionEvent","listener","isNaN","setTimeout","AbstractPlugin"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;EAAAA,OAAO,CAACC,IAAR,CAAc,0UAAd;EACA;;;;;;;AAOAC,gBAAK,CAACC,yBAAN,GAAkC,UAAWC,MAAX,EAAoB;EAErD,MAAIC,KAAK,GAAG,IAAZ;EAEA,OAAKD,MAAL,GAAcA,MAAd;EACA,OAAKA,MAAL,CAAYE,QAAZ,CAAqBC,OAArB,CAA8B,KAA9B;EAEA,OAAKC,OAAL,GAAe,IAAf;EAEA,OAAKC,iBAAL,GAAyB,EAAzB;EACA,OAAKC,iBAAL,GAAyB,CAAzB;EAEA,OAAKC,WAAL,GAAmB,CAAnB,CAZqD;;EAcrD,MAAIC,8BAA8B,GAAG,SAAjCA,8BAAiC,CAAWC,KAAX,EAAmB;EAEvDR,IAAAA,KAAK,CAACI,iBAAN,GAA0BI,KAA1B;EAEA,GAJD;;EAMA,MAAIC,8BAA8B,GAAG,SAAjCA,8BAAiC,GAAY;EAEhDT,IAAAA,KAAK,CAACK,iBAAN,GAA0BK,MAAM,CAACC,WAAP,IAAsB,CAAhD;EAEA,GAJD,CApBqD;;;EA4BrD,MAAIC,mBAAmB,GAAG,YAAY;EAErC,QAAIC,GAAG,GAAG,IAAIhB,cAAK,CAACiB,OAAV,CAAmB,CAAnB,EAAsB,CAAtB,EAAyB,CAAzB,CAAV;EAEA,QAAIC,KAAK,GAAG,IAAIlB,cAAK,CAACmB,KAAV,EAAZ;EAEA,QAAIC,EAAE,GAAG,IAAIpB,cAAK,CAACqB,UAAV,EAAT;EAEA,QAAIC,EAAE,GAAG,IAAItB,cAAK,CAACqB,UAAV,CAAsB,CAAEE,IAAI,CAACC,IAAL,CAAW,GAAX,CAAxB,EAA0C,CAA1C,EAA6C,CAA7C,EAAgDD,IAAI,CAACC,IAAL,CAAW,GAAX,CAAhD,CAAT,CARqC;;EAUrC,WAAO,UAAWC,UAAX,EAAuBC,KAAvB,EAA8BC,IAA9B,EAAoCC,KAApC,EAA2CC,MAA3C,EAAoD;EAE1DX,MAAAA,KAAK,CAACY,GAAN,CAAWH,IAAX,EAAiBD,KAAjB,EAAwB,CAAEE,KAA1B,EAAiC,KAAjC,EAF0D;;EAI1DH,MAAAA,UAAU,CAACM,YAAX,CAAyBb,KAAzB,EAJ0D;;EAM1DO,MAAAA,UAAU,CAACO,QAAX,CAAqBV,EAArB,EAN0D;;EAQ1DG,MAAAA,UAAU,CAACO,QAAX,CAAqBZ,EAAE,CAACa,gBAAH,CAAqBjB,GAArB,EAA0B,CAAEa,MAA5B,CAArB,EAR0D;EAU1D,KAVD;EAYA,GAtByB,EAA1B;;EAwBA,OAAKK,OAAL,GAAe,YAAY;EAE1BtB,IAAAA,8BAA8B,GAFJ;EAI1B;;EAEA,QAAKC,MAAM,CAACsB,sBAAP,KAAkCC,SAAlC,IAA+C,OAAOvB,MAAM,CAACsB,sBAAP,CAA8BE,iBAArC,KAA2D,UAA/G,EAA4H;EAE3HxB,MAAAA,MAAM,CAACsB,sBAAP,CAA8BE,iBAA9B,GAAkDC,IAAlD,CAAwD,UAAWC,QAAX,EAAsB;EAE7E,YAAKA,QAAQ,IAAI,SAAjB,EAA6B;EAE5B1B,UAAAA,MAAM,CAAC2B,gBAAP,CAAyB,mBAAzB,EAA8C5B,8BAA9C,EAA8E,KAA9E;EACAC,UAAAA,MAAM,CAAC2B,gBAAP,CAAyB,mBAAzB,EAA8C9B,8BAA9C,EAA8E,KAA9E;EAEA;EAED,OATD,EASI+B,KATJ,CASW,UAAWC,KAAX,EAAmB;EAE7B5C,QAAAA,OAAO,CAAC4C,KAAR,CAAe,uEAAf,EAAwFA,KAAxF;EAEA,OAbD;EAeA,KAjBD,MAiBO;EAEN7B,MAAAA,MAAM,CAAC2B,gBAAP,CAAyB,mBAAzB,EAA8C5B,8BAA9C,EAA8E,KAA9E;EACAC,MAAAA,MAAM,CAAC2B,gBAAP,CAAyB,mBAAzB,EAA8C9B,8BAA9C,EAA8E,KAA9E;EAEA;;EAEDP,IAAAA,KAAK,CAACG,OAAN,GAAgB,IAAhB;EAEA,GAhCD;;EAkCA,OAAKqC,UAAL,GAAkB,YAAY;EAE7B9B,IAAAA,MAAM,CAAC+B,mBAAP,CAA4B,mBAA5B,EAAiDhC,8BAAjD,EAAiF,KAAjF;EACAC,IAAAA,MAAM,CAAC+B,mBAAP,CAA4B,mBAA5B,EAAiDlC,8BAAjD,EAAiF,KAAjF;EAEAP,IAAAA,KAAK,CAACG,OAAN,GAAgB,KAAhB;EAEA,GAPD;;EASA,OAAKuC,MAAL,GAAc,YAAY;EAEzB,QAAK1C,KAAK,CAACG,OAAN,KAAkB,KAAvB,EAA+B;EAE/B,QAAIwC,MAAM,GAAG3C,KAAK,CAACI,iBAAnB;;EAEA,QAAKuC,MAAL,EAAc;EAEb,UAAIpB,KAAK,GAAGoB,MAAM,CAACpB,KAAP,GAAe1B,cAAK,CAAC+C,SAAN,CAAgBC,QAAhB,CAA0BF,MAAM,CAACpB,KAAjC,IAA2CvB,KAAK,CAACM,WAAhE,GAA8E,CAA1F,CAFa;;EAIb,UAAIkB,IAAI,GAAGmB,MAAM,CAACnB,IAAP,GAAc3B,cAAK,CAAC+C,SAAN,CAAgBC,QAAhB,CAA0BF,MAAM,CAACnB,IAAjC,CAAd,GAAwD,CAAnE,CAJa;;EAMb,UAAIC,KAAK,GAAGkB,MAAM,CAAClB,KAAP,GAAe5B,cAAK,CAAC+C,SAAN,CAAgBC,QAAhB,CAA0BF,MAAM,CAAClB,KAAjC,CAAf,GAA0D,CAAtE,CANa;;EAQb,UAAIC,MAAM,GAAG1B,KAAK,CAACK,iBAAN,GAA0BR,cAAK,CAAC+C,SAAN,CAAgBC,QAAhB,CAA0B7C,KAAK,CAACK,iBAAhC,CAA1B,GAAgF,CAA7F,CARa;;EAUbO,MAAAA,mBAAmB,CAAEZ,KAAK,CAACD,MAAN,CAAauB,UAAf,EAA2BC,KAA3B,EAAkCC,IAAlC,EAAwCC,KAAxC,EAA+CC,MAA/C,CAAnB;EAEA;EAGD,GArBD;;EAuBA,OAAKoB,OAAL,GAAe,YAAY;EAE1B9C,IAAAA,KAAK,CAACwC,UAAN;EAEA,GAJD;;EAMA,OAAKT,OAAL;EAEA,CA9HD;;;;ECJA;;;;;;MAKagB,eAAb;EAAA;;EAKE;;;EAGA,2BAAYC,MAAZ,EAAoB;EAAA;;EAClB,uCAAMA,MAAN,EAAc,8CAAd,EAA8D,IAA9D;EAEA;;;;;;EAKA,UAAKC,MAAL,GAAc,MAAKC,GAAL,CAASC,SAAT,CAAmBC,eAAe,CAACC,EAAnC,CAAd;;EAEA,QAAI,MAAKJ,MAAT,EAAiB;EACf,YAAKA,MAAL,CAAYK,EAAZ,CAAeF,eAAe,CAACG,MAAhB,CAAuBC,iBAAtC;EACD;;EAZiB;EAanB;EAED;;;;;EAvBF;;EAAA,SA0BEC,OA1BF,GA0BE,mBAAU;EACR,QAAI,KAAKR,MAAT,EAAiB;EACf,WAAKA,MAAL,CAAYS,GAAZ,CAAgBN,eAAe,CAACG,MAAhB,CAAuBC,iBAAvC,EAA0D,IAA1D;EACD;;EAED,WAAO,KAAKP,MAAZ;;EAEA,8BAAMQ,OAAN;EACD;EAED;;;EApCF;;EAAA,SAuCEE,WAvCF,GAuCE,uBAAc;EACZ,WAAO,CAAC,KAAKV,MAAN,GAAe,KAAf,GAAuB;EAAEW,MAAAA,OAAO,EAAE,KAAX;EAAkBC,MAAAA,OAAO,EAAE,KAAKZ,MAAL,CAAYa,IAAZ,CAAiBH;EAA5C,KAA9B;EACD;EAED;;;;;EA3CF;;EAAA,SAgDEI,WAhDF,GAgDE,qBAAYC,CAAZ,EAAe;EACb,QAAIA,CAAC,CAACC,IAAF,KAAWb,eAAe,CAACG,MAAhB,CAAuBC,iBAAtC,EAAyD;EACvD,WAAKU,YAAL,CAAkBF,CAAC,CAACG,IAAF,CAAO,CAAP,CAAlB;EACD;EACF;EAED;;;;EAtDF;;EAAA,SA0DEC,OA1DF,GA0DE,mBAAU;EACR,SAAKnB,MAAL,CAAYoB,MAAZ;EACD,GA5DH;;EAAA;EAAA,EAAqCC,gCAArC;EAAavB,gBAEJM,KAAK;EAFDN,gBAGJwB,OAAOC;;ECPhB;;;;EAMA;;AACAC,4BAAQ,CAACzB,MAAT,CAAgB0B,MAAhB,CAAuB,CAAC,CAAxB,EAA2B,CAA3B,EAA8B3B,eAAe,CAACM,EAA9C;AACAoB,4BAAQ,CAACE,IAAT,CAAc5B,eAAe,CAACM,EAA9B,IAAoC,WAApC;AACAuB,kCAAc,CAAC7B,eAAD,CAAd;EAGA;;;;;;MAKqBK;;;EAInB;;;;;;;EAUA;;;EAGA,2BAAYF,GAAZ,EAAiB;EAAA;;EACf,uCAAMA,GAAN;EAEA;;;;;;;;;EAQA,UAAKY,IAAL,GAAY;EACVH,MAAAA,WAAW,EAAS,MAAKkB,cAAL,EADV;EAEVvE,MAAAA,WAAW,EAAS,CAFV;EAGVwE,MAAAA,aAAa,EAAO,IAHV;EAIVC,MAAAA,kBAAkB,EAAE;EAJV,KAAZ;EAOA;;;;;EAIA,UAAKC,QAAL,GAAgB,IAAhB;;EAEA,UAAK9B,GAAL,CAASI,EAAT,CAAY2B,2BAAS,CAAC1B,MAAV,CAAiB2B,QAA7B;;EACA,UAAKhC,GAAL,CAASI,EAAT,CAAY2B,2BAAS,CAAC1B,MAAV,CAAiB4B,aAA7B;;EAzBe;EA0BhB;EAED;;;;;;;WAGA1B,UAAA,mBAAU;EACR,SAAKP,GAAL,CAASQ,GAAT,CAAauB,2BAAS,CAAC1B,MAAV,CAAiB2B,QAA9B,EAAwC,IAAxC;EACA,SAAKhC,GAAL,CAASQ,GAAT,CAAauB,2BAAS,CAAC1B,MAAV,CAAiB4B,aAA9B,EAA6C,IAA7C;EAEA,SAAKC,IAAL;EAEA,WAAO,KAAKJ,QAAZ;EACA,WAAO,KAAKlB,IAAZ;;EAEA,8BAAML,OAAN;EACD;EAED;;;;;WAGAM,cAAA,qBAAYC,CAAZ,EAAe;EACb,YAAQA,CAAC,CAACC,IAAV;EACE,WAAKgB,2BAAS,CAAC1B,MAAV,CAAiB2B,QAAtB;EACE,aAAKE,IAAL;EACA;;EACF,WAAKH,2BAAS,CAAC1B,MAAV,CAAiB4B,aAAtB;EACE,aAAKE,UAAL,CAAgBrB,CAAhB;;EACA;EANJ;EAUD;EAED;;;;;;WAIAsB,YAAA,qBAAY;EACV,WAAO,CAAC,CAAC,KAAKxB,IAAL,CAAUgB,aAAnB;EACD;EAED;;;;;;;;WAMAS,QAAA,iBAAQ;EAAA;;EACN,WAAO,KAAKzB,IAAL,CAAUH,WAAV,CACJxB,IADI,CACC,UAACqD,SAAD,EAAe;EACnB,UAAIA,SAAJ,EAAe;EACb,eAAO,MAAI,CAACC,mBAAL,EAAP;EACD,OAFD,MAGK;EACHC,QAAAA,uBAAK,CAACC,OAAN,CAAc,yBAAd;EACA,eAAOC,OAAO,CAACC,MAAR,EAAP;EACD;EACF,KATI,EAUJ1D,IAVI,CAUC,UAAC2D,OAAD,EAAa;EACjB,UAAIA,OAAJ,EAAa;EACX,eAAOF,OAAO,CAACG,OAAR,EAAP;EACD,OAFD,MAGK;EACHL,QAAAA,uBAAK,CAACC,OAAN,CAAc,uBAAd;EACA,eAAOC,OAAO,CAACC,MAAR,EAAP;EACD;EACF,KAlBI,EAmBJ1D,IAnBI,CAmBC,YAAM;EACV,MAAA,MAAI,CAACe,GAAL,CAAS8C,SAAT,GADU;;;EAIV,MAAA,MAAI,CAAClC,IAAL,CAAUiB,kBAAV,GAA+B,MAAI,CAAC7B,GAAL,CAAS+C,MAAT,CAAgBC,WAA/C;EACA,MAAA,MAAI,CAAChD,GAAL,CAAS+C,MAAT,CAAgBC,WAAhB,GAA8B,KAA9B;;EAEA,MAAA,MAAI,CAACC,WAAL;EAEA;;;;;;;;EAMA,MAAA,MAAI,CAACC,OAAL,CAAahD,eAAe,CAACG,MAAhB,CAAuBC,iBAApC,EAAuD,IAAvD;EACD,KAnCI,CAAP;EAoCD;EAED;;;;;;WAIA4B,OAAA,gBAAO;EACL,QAAI,KAAKE,SAAL,EAAJ,EAAsB;EACpB,WAAKN,QAAL,CAAcxC,UAAd;EAEA,WAAKU,GAAL,CAASQ,GAAT,CAAauB,2BAAS,CAAC1B,MAAV,CAAiB8C,aAA9B,EAA6C,KAAKvC,IAAL,CAAUgB,aAAvD;EACA,WAAKhB,IAAL,CAAUgB,aAAV,GAA0B,IAA1B;EAEA,WAAK5B,GAAL,CAAS+C,MAAT,CAAgBC,WAAhB,GAA8B,KAAKpC,IAAL,CAAUiB,kBAAxC;EAEA,WAAKqB,OAAL,CAAahD,eAAe,CAACG,MAAhB,CAAuBC,iBAApC,EAAuD,KAAvD;EACD;EACF;EAED;;;;;WAGAa,SAAA,kBAAS;EACP,QAAI,KAAKiB,SAAL,EAAJ,EAAsB;EACpB,WAAKF,IAAL;EACD,KAFD,MAGK;EACH,WAAKG,KAAL;EACD;EACF;EAED;;;;;;WAIAY,cAAA,uBAAc;EAAA;;EACZ,QAAI,CAAC,KAAKnB,QAAV,EAAoB;EAClB,WAAKA,QAAL,GAAgB,IAAInF,+BAAJ,CAAoC,KAAKqD,GAAL,CAASoD,QAAT,CAAkBC,MAAtD,CAAhB;EACD,KAFD,MAGK;EACH,WAAKvB,QAAL,CAAcjD,OAAd;EACD;;EAED,QAAMyE,SAAS,GAAG,KAAKtD,GAAL,CAASoD,QAAT,CAAkBC,MAAlB,CAAyBE,iBAAzB,CAA2C,IAAI5G,aAAJ,EAA3C,CAAlB;EACA,QAAM6G,kBAAkB,GAAG,KAAKxD,GAAL,CAASyD,UAAT,CAAoBC,wBAApB,CAA6CJ,SAA7C,CAA3B;EACA,SAAK1C,IAAL,CAAUxD,WAAV,GAAwBoF,uBAAK,CAACmB,cAAN,CAAqB,KAAK3D,GAAL,CAASY,IAAT,CAAcgD,QAAd,CAAuBC,SAA5C,EAAuDL,kBAAkB,CAACK,SAA1E,CAAxB;;EAEA,SAAKjD,IAAL,CAAUgB,aAAV,GAA0B,YAAM;EAC9B,MAAA,MAAI,CAACE,QAAL,CAAc1E,WAAd,GAA4B,MAAI,CAACwD,IAAL,CAAUxD,WAAtC;;EACA,MAAA,MAAI,CAAC0E,QAAL,CAActC,MAAd;;EAEA,MAAA,MAAI,CAACQ,GAAL,CAASoD,QAAT,CAAkBC,MAAlB,CAAyBE,iBAAzB,CAA2C,MAAI,CAACvD,GAAL,CAASY,IAAT,CAAc0C,SAAzD;;EACA,MAAA,MAAI,CAACtD,GAAL,CAASY,IAAT,CAAc0C,SAAd,CAAwBQ,cAAxB,CAAuC/B,2BAAS,CAACgC,aAAjD;;EAEA,UAAMC,eAAe,GAAG,MAAI,CAAChE,GAAL,CAASyD,UAAT,CAAoBC,wBAApB,CAA6C,MAAI,CAAC1D,GAAL,CAASY,IAAT,CAAc0C,SAA3D,CAAxB;;EACA,MAAA,MAAI,CAACtD,GAAL,CAASY,IAAT,CAAcgD,QAAd,CAAuBC,SAAvB,GAAmCG,eAAe,CAACH,SAAnD;EACA,MAAA,MAAI,CAAC7D,GAAL,CAASY,IAAT,CAAcgD,QAAd,CAAuBK,QAAvB,GAAkCD,eAAe,CAACC,QAAlD;;EACA,MAAA,MAAI,CAACjE,GAAL,CAASkE,WAAT;EACD,KAXD;;EAaA,SAAKlE,GAAL,CAASI,EAAT,CAAY2B,2BAAS,CAAC1B,MAAV,CAAiB8C,aAA7B,EAA4C,KAAKvC,IAAL,CAAUgB,aAAtD;EACD;EAED;;;;;;;WAKAO,aAAA,oBAAWrB,CAAX,EAAc;EACZ,QAAI,KAAKsB,SAAL,EAAJ,EAAsB;EACpBtB,MAAAA,CAAC,CAACqD,cAAF;EAEA,WAAKvD,IAAL,CAAUxD,WAAV,IAAyB0D,CAAC,CAACG,IAAF,CAAO,CAAP,EAAU4C,SAAV,GAAsB,KAAK7D,GAAL,CAASY,IAAT,CAAcgD,QAAd,CAAuBC,SAAtE;EACD;EACF;EAED;;;;;;;WAKAlC,iBAAA,0BAAiB;EACf,QAAI,uBAAuBnE,MAAvB,IAAiC,OAAO4G,iBAAiB,CAACpF,iBAAzB,KAA+C,UAApF,EAAgG;EAC9F,aAAO0D,OAAO,CAACG,OAAR,CAAgB,IAAhB,CAAP;EACD,KAFD,MAGK,IAAI,4BAA4BrF,MAAhC,EAAwC;EAC3C,aAAO,IAAIkF,OAAJ,CAAY,UAACG,OAAD,EAAa;EAC9B,YAAMwB,QAAQ,GAAG,SAAXA,QAAW,CAACvD,CAAD,EAAO;EACtB;EACA+B,UAAAA,OAAO,CAAC/B,CAAC,IAAIA,CAAC,CAACzC,KAAF,KAAY,IAAjB,IAAyB,CAACiG,KAAK,CAACxD,CAAC,CAACzC,KAAH,CAAhC,CAAP;EAEAb,UAAAA,MAAM,CAAC+B,mBAAP,CAA2B,mBAA3B,EAAgD8E,QAAhD;EACD,SALD;;EAOA7G,QAAAA,MAAM,CAAC2B,gBAAP,CAAwB,mBAAxB,EAA6CkF,QAA7C,EAAuD,KAAvD,EAR8B;;EAW9BE,QAAAA,UAAU,CAACF,QAAD,EAAW,IAAX,CAAV;EACD,OAZM,CAAP;EAaD,KAdI,MAeA;EACH,aAAO3B,OAAO,CAACG,OAAR,CAAgB,KAAhB,CAAP;EACD;EACF;EAED;;;;;;;WAKAN,sBAAA,+BAAsB;EACpB,QAAI,uBAAuB/E,MAAvB,IAAiC,OAAO4G,iBAAiB,CAACpF,iBAAzB,KAA+C,UAApF,EAAgG;EAC9F,aAAOF,sBAAsB,CAACE,iBAAvB,GACJC,IADI,CACC,UAAAC,QAAQ;EAAA,eAAIA,QAAQ,KAAK,SAAjB;EAAA,OADT,EAEJE,KAFI,CAEE;EAAA,eAAM,KAAN;EAAA,OAFF,CAAP;EAGD,KAJD,MAKK;EACH,aAAOsD,OAAO,CAACG,OAAR,CAAgB,IAAhB,CAAP;EACD;EACF;;;IAtP0C2B;;EAAxBtE,gBAEZC,KAAK;EAFOD,gBAUZG,SAAS;EACdC,EAAAA,iBAAiB,EAAE;EADL;;;;;;;;"}